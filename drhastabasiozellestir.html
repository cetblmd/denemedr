<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Dr Hasta BaÅŸÄ± Ã–zelleÅŸtir</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SortableJS: sÃ¼rÃ¼kle-bÄ±rak iÃ§in kÃ¼Ã§Ã¼k ve hafif bir kÃ¼tÃ¼phane -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f3f4f6;
            color: #111827;
        }
        .page {
            max-width: 720px;
            margin: 20px auto;
            background: #ffffff;
            border-radius: 12px;
            padding: 16px 18px 20px;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
            position: relative;
        }
        h1 {
            font-size: 20px;
            margin: 0 0 10px;
        }

        .status-container {
            font-size: 12px;
            min-height: 18px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 4px;
        }

        .badge-ok {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: #ecfdf3;
            color: #15803d;
        }
        .badge-error {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: #fef2f2;
            color: #b91c1c;
        }

        /* SaÄŸ Ã¼stteki aksiyonlar (Kaydet + Kapat) */
        .top-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Kapat butonu */
        #closeConfigBtn {
            background: #ff5c5c;
            border: none;
            color: white;
            padding: 4px 7px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
        }

        /* AÃ§/kapatlÄ± bÃ¶lÃ¼m (accordion) */
        .section {
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            margin-top: 10px;
        }

        .section-header {
            width: 100%;
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }

        .section-header:hover {
            background: #eef2ff;
        }

        .section-arrow {
            font-size: 14px;
            transition: transform 0.2s ease;
        }

        .section-title {
            flex: 1;
            text-align: left;
        }

        .section-body {
            padding: 6px 8px 10px;
            border-top: 1px solid #e5e7eb;
        }

        .section.collapsed .section-body {
            display: none;
        }

        .section.collapsed .section-arrow {
            transform: rotate(-90deg);
        }

        .btn {
            border-radius: 999px;
            border: 1px solid transparent;
            font-size: 13px;
            padding: 6px 14px;
            cursor: pointer;
        }
        .btn-ghost {
            background: #ffffff;
            border-color: #d1d5db;
            color: #374151;
        }
        .btn-ghost:hover {
            background: #f3f4f6;
        }
        .btn-primary {
            background: #0b3c61;
            color: #ffffff;
        }
        .btn-primary:hover {
            background: #0d4979;
        }

        .btn-sm {
            font-size: 12px;
            padding: 5px 10px;
        }

        /* --- SOL PANEL LÄ°STESÄ° --- */
        .panel-list {
            list-style: none;
            padding: 0;
            margin: 0 0 8px;
        }

        .panel-header,
        .panel-item {
            display: grid;
            grid-template-columns: 70px minmax(0, 1fr) 130px;
            align-items: center;
            padding: 8px 10px;
        }

        .panel-header {
            margin-bottom: 4px;
            padding-left: 10px;
            padding-right: 10px;
            font-size: 13px;
            color: #374151;
            font-weight: 600;
        }

        .panel-item {
            margin-bottom: 4px;
            border-radius: 8px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            cursor: grab;
            transition: box-shadow 0.15s ease, transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
        }

        .panel-left {
            grid-column: 2;
            display: flex;
            align-items: center;
            gap: 14px;
            margin-left: -24px;
        }

        .drag-handle {
            font-size: 18px;
            user-select: none;
            color: #9ca3af;
            cursor: grab;
        }
        .panel-title {
            font-size: 14px;
            font-weight: 500;
        }
        .panel-key {
            font-size: 11px;
            color: #9ca3af;
        }

        .col-visible {
            grid-column: 1;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 0;
            gap: 4px;
        }

        .col-default {
            grid-column: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .ph-visible-label,
        .ph-default-label {
            font-size: 13px;
        }

        .panel-enabled-checkbox,
        .panel-open-checkbox,
        #toggleAllVisible,
        #toggleAllOpen,
        .qa-enabled-checkbox,
        #qaToggleAllVisible {
            width: 16px;
            height: 16px;
            margin: 0;
            vertical-align: middle;
        }

        .panel-item.sortable-chosen,
        .qa-item.sortable-chosen {
            border-color: #0b3c61;
            background: #eef2ff;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.25);
            transform: scale(1.01);
            z-index: 10;
        }
        .panel-item.sortable-ghost,
        .qa-item.sortable-ghost {
            opacity: 0.4;
        }

        .section-btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 6px;
        }

        /* --- HIZLI ERÄ°ÅžÄ°M LÄ°STESÄ° --- */
        .qa-list {
            list-style: none;
            padding: 0;
            margin: 0 0 8px;
        }

        .qa-header,
        .qa-item {
            display: grid;
            grid-template-columns: 80px minmax(0, 1fr);
            align-items: center;
            padding: 8px 10px;
        }

        .qa-header {
            margin-bottom: 4px;
            font-size: 13px;
            color: #374151;
            font-weight: 600;
        }

        .qa-item {
            margin-bottom: 4px;
            border-radius: 8px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            cursor: grab;
            transition: box-shadow 0.15s ease, transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
        }

        .qa-visible {
            grid-column: 1;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .qa-main {
            grid-column: 2;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qa-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .qa-title {
            font-size: 14px;
            font-weight: 500;
        }

        .qa-key {
            font-size: 11px;
            color: #9ca3af;
        }

        .qa-drag {
            font-size: 16px;
            color: #9ca3af;
            cursor: grab;
            margin-left: 4px;
        }

        .qa-align-row {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 10px;
            margin: 4px 10px 8px;
            font-size: 13px;
            color: #374151;
        }

        .qa-align-options {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .qa-align-options label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        @media (max-width: 600px) {
            .page {
                margin: 8px;
                padding: 12px;
            }

            .panel-header,
            .panel-item {
                grid-template-columns: 60px minmax(0, 1.6fr) 110px;
            }

            .ph-visible-label,
            .ph-default-label {
                font-size: 11px;
                white-space: nowrap;
            }

            .panel-title {
                font-size: 13px;
            }

            .qa-header,
            .qa-item {
                grid-template-columns: 70px minmax(0, 1fr);
            }

            .qa-title {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>

<div class="page">

    <!-- SaÄŸ Ã¼st: TÃ¼mÃ¼nÃ¼ Kaydet + Ã‡Ä±kÄ±ÅŸ -->
    <div class="top-actions">
        <button id="saveAllBtn" class="btn btn-primary">TÃ¼mÃ¼nÃ¼ Kaydet</button>
        <button id="closeConfigBtn">âœ–</button>
    </div>

    <!-- Ãœst aÃ§Ä±klama: Mobile / Tablet / PC iÃ§in Dr Hasta BaÅŸÄ± Ã–zelleÅŸtir -->
    <h1 id="mainTitle">Dr Hasta BaÅŸÄ± Ã–zelleÅŸtir</h1>

    <div class="status-container">
        <span id="modeInfo"></span>
        <span id="statusBadge"></span>
    </div>

    <!-- SOL PANEL BÃ–LÃœMÃœ: BAÅžLANGIÃ‡TA KAPALI -->
    <div class="section collapsed" id="solPanelSection">
        <button class="section-header" id="solPanelToggle" type="button">
            <span class="section-arrow">â–¼</span>
            <span class="section-title">Sol Panel</span>
        </button>
        <div class="section-body" id="solPanelBody">

            <div class="panel-header">
                <div class="col-visible">
                    <input type="checkbox" id="toggleAllVisible">
                    <span class="ph-visible-label">GÃ¶rÃ¼nsÃ¼n</span>
                </div>

                <div></div>

                <div class="col-default">
                    <input type="checkbox" id="toggleAllOpen">
                    <span class="ph-default-label">AÃ§Ä±lÄ±ÅŸta aÃ§Ä±k</span>
                </div>
            </div>

            <ul id="panelList" class="panel-list"></ul>

            <div class="section-btn-row">
                <button id="resetSolBtn" class="btn btn-ghost btn-sm">Sol Panelin VarsayÄ±lanlarÄ±nÄ± Getir</button>
            </div>
        </div>
    </div>

    <!-- HIZLI ERÄ°ÅžÄ°M (2. SATIR) BÃ–LÃœMÃœ: BAÅžLANGIÃ‡TA KAPALI -->
    <div class="section collapsed" id="quickSection">
        <button class="section-header" id="quickToggle" type="button">
            <span class="section-arrow">â–¼</span>
            <span class="section-title">HÄ±zlÄ± EriÅŸim ButonlarÄ±</span>
        </button>
        <div class="section-body" id="quickBody">

            <div class="qa-align-row">
                <span><b>Buton HizalamasÄ±:</b></span>
                <div class="qa-align-options">
                    <label>
                        <input type="radio" name="qaAlign" value="left">
                        Sola
                    </label>
                    <label>
                        <input type="radio" name="qaAlign" value="center">
                        Ortada
                    </label>
                    <label>
                        <input type="radio" name="qaAlign" value="right" checked>
                        SaÄŸa
                    </label>
                </div>
            </div>

            <div class="qa-header">
		<div class="qa-visible">
		        <input type="checkbox" id="qaToggleAllVisible">
		        <span class="ph-visible-label">GÃ¶rÃ¼nsÃ¼n</span>
		</div>

    		<div class="qa-bar-visible" style="margin-left:20px; display:flex; align-items:center; gap:6px;">
		        <input type="checkbox" id="qaBarVisible">
		        <span class="ph-visible-label">Bar GÃ¶zÃ¼ksÃ¼n</span>
		    </div>
	    </div>


            <ul id="quickList" class="qa-list"></ul>

            <div class="section-btn-row">
                <button id="resetQuickBtn" class="btn btn-ghost btn-sm">HÄ±zlÄ± EriÅŸimin VarsayÄ±lanlarÄ±nÄ± Getir</button>
            </div>
        </div>
    </div>

</div>

<script>
function detectDeviceMode() {
    const w = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
    if (w <= 768) {
        return { mode: 'mobile', label: 'Mobile' };
    }
    if (w <= 1024) {
        return { mode: 'tablet', label: 'Tablet' };
    }
    return { mode: 'desktop', label: 'PC' };
}

const DEVICE = detectDeviceMode();
const ACTIVE_MODE = DEVICE.mode;
const MODE_LABEL = DEVICE.label;

const mainTitleEl = document.getElementById('mainTitle');
if (mainTitleEl) {
    mainTitleEl.textContent = `${MODE_LABEL} iÃ§in Dr Hasta BaÅŸÄ± Ã–zelleÅŸtir`;
}

const modeInfoEl = document.getElementById('modeInfo');
if (modeInfoEl) {
    modeInfoEl.textContent = `${MODE_LABEL} gÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in Ã¶zelleÅŸtirme yapÄ±yorsunuz`;
}

/* ---------- SOL PANEL TANIMLARI ---------- */
const ALL_PANELS = [
    { id: 'panel-hasta-bilgisi',  title: 'Hasta Bilgisi' },
    { id: 'panel-muayene',        title: 'Muayene Bilgileri' },
    { id: 'panel-teshis',         title: 'TeÅŸhis KodlarÄ±' },
    { id: 'panel-laboratuvar',    title: 'Laboratuvar SonuÃ§larÄ±' },
    { id: 'panel-radyoloji',      title: 'Radyoloji SonuÃ§larÄ±' },
    { id: 'panel-recete',         title: 'Ä°laÃ§ ReÃ§eteleri' },
    { id: 'panel-asi',            title: 'AÅŸÄ± ve BaÄŸÄ±ÅŸÄ±klama' },
    { id: 'panel-notlar',         title: 'Hekim NotlarÄ± ve Plan' },
    { id: 'panel-randevu',        title: 'Randevu ve Kontroller' }
];

const SOL_STORAGE_KEY   = 'solPanelConfig';
const QUICK_STORAGE_KEY = 'quickAccessConfig';

const panelListEl    = document.getElementById('panelList');
const resetSolBtn    = document.getElementById('resetSolBtn');

const quickListEl    = document.getElementById('quickList');
const resetQuickBtn  = document.getElementById('resetQuickBtn');

const saveAllBtn     = document.getElementById('saveAllBtn');
const statusBadge    = document.getElementById('statusBadge');

let solSortableInstance   = null;
let quickSortableInstance = null;

function getDefaultSolConfigArray() {
    return ALL_PANELS.map((p, index) => ({
        id: p.id,
        enabled: true,
        isDefault: index === 0,
        acikDurum: index === 0
    }));
}

function loadSolRawMultiConfig() {
    try {
        const raw = localStorage.getItem(SOL_STORAGE_KEY);
        if (!raw) {
            return { desktop: null, tablet: null, mobile: null };
        }
        const parsed = JSON.parse(raw);

        if (Array.isArray(parsed)) {
            return {
                desktop: parsed,
                tablet: parsed,
                mobile: parsed
            };
        }

        if (parsed && typeof parsed === 'object') {
            return {
                desktop: Array.isArray(parsed.desktop) ? parsed.desktop : null,
                tablet:  Array.isArray(parsed.tablet)  ? parsed.tablet  : null,
                mobile:  Array.isArray(parsed.mobile)  ? parsed.mobile  : null
            };
        }

        return { desktop: null, tablet: null, mobile: null };
    } catch (e) {
        console.error('solPanelConfig parse hatasÄ±:', e);
        return { desktop: null, tablet: null, mobile: null };
    }
}

function loadSolConfigForActiveMode() {
    const rawMulti = loadSolRawMultiConfig();
    let arr = rawMulti[ACTIVE_MODE];

    if (!Array.isArray(arr)) {
        arr = rawMulti.desktop || rawMulti.tablet || rawMulti.mobile || null;
    }

    if (!Array.isArray(arr)) {
        return getDefaultSolConfigArray();
    }

    const knownIds = new Set(ALL_PANELS.map(p => p.id));
    const result = [];

    for (const item of arr) {
        if (!item || typeof item.id !== 'string') continue;
        if (!knownIds.has(item.id)) continue;

        const acikDurum =
            (typeof item.acikDurum !== 'undefined')
                ? !!item.acikDurum
                : !!item.isDefault;

        result.push({
            id: item.id,
            enabled: item.enabled !== false,
            isDefault: !!item.isDefault,
            acikDurum
        });
    }

    const existingIds = new Set(result.map(r => r.id));
    for (const p of ALL_PANELS) {
        if (!existingIds.has(p.id)) {
            result.push({
                id: p.id,
                enabled: true,
                isDefault: false,
                acikDurum: false
            });
        }
    }

    let firstOpenIndex = result.findIndex(r => r.enabled && r.acikDurum);
    if (firstOpenIndex === -1) {
        const firstEnabled = result.findIndex(r => r.enabled);
        if (firstEnabled !== -1) {
            result[firstEnabled].acikDurum = true;
            result[firstEnabled].isDefault = true;
        }
    }

    // GÃ¶rÃ¼nsÃ¼n seÃ§ili olanlarÄ± Ã¼ste al (stable)
    const enabledArr = [];
    const disabledArr = [];
    for (const it of result) {
        if (it.enabled) enabledArr.push(it);
        else disabledArr.push(it);
    }
    return enabledArr.concat(disabledArr);
}

function saveSolConfigForActiveMode(configArray) {
    try {
        const rawMulti = loadSolRawMultiConfig();

        rawMulti[ACTIVE_MODE] = configArray;

        const toStore = {
            desktop: rawMulti.desktop || null,
            tablet:  rawMulti.tablet  || null,
            mobile:  rawMulti.mobile  || null
        };

        localStorage.setItem(SOL_STORAGE_KEY, JSON.stringify(toStore));
    } catch (e) {
        console.error('Sol config kaydedilirken hata:', e);
        throw e;
    }
}

function showStatus(text, ok) {
    if (!statusBadge) return;
    statusBadge.innerHTML = '';
    const span = document.createElement('span');
    span.textContent = text;
    span.className = ok ? 'badge-ok' : 'badge-error';
    statusBadge.appendChild(span);
    setTimeout(() => {
        if (statusBadge.contains(span)) {
            statusBadge.removeChild(span);
        }
    }, 2500);
}

function renderSolList(config) {
    if (!panelListEl) return;
    panelListEl.innerHTML = '';

    config.forEach(item => {
        const panelDef = ALL_PANELS.find(p => p.id === item.id);
        if (!panelDef) return;

        const li = document.createElement('li');
        li.className = 'panel-item';
        li.dataset.id = item.id;

        const visId = 'visible-' + item.id;
        const openId = 'open-' + item.id;

        li.innerHTML = `
            <div class="col-visible">
                <input type="checkbox"
                       id="${visId}"
                       class="panel-enabled-checkbox"
                       ${item.enabled ? 'checked' : ''}>
            </div>

            <div class="panel-left">
                <span class="drag-handle" title="SÃ¼rÃ¼kle">â˜°</span>
                <div>
                    <div class="panel-title">${panelDef.title}</div>
                    <div class="panel-key">${panelDef.id}</div>
                </div>
            </div>

            <div class="col-default">
                <input type="checkbox"
                       id="${openId}"
                       class="panel-open-checkbox"
                       ${item.acikDurum ? 'checked' : ''}>
            </div>
        `;

        panelListEl.appendChild(li);
    });

    const masterVisible = document.getElementById('toggleAllVisible');
    const masterOpen    = document.getElementById('toggleAllOpen');

    if (masterVisible) {
        const anyOff = config.some(c => !c.enabled);
        masterVisible.checked = !anyOff;
    }
    if (masterOpen) {
        const anyClosed = config.some(c => !c.acikDurum);
        masterOpen.checked = !anyClosed;
    }

    initSolSortable();
    attachSolConfigInteractions();
}

function attachSolConfigInteractions() {
    const items         = panelListEl ? panelListEl.querySelectorAll('.panel-item') : [];
    const masterVisible = document.getElementById('toggleAllVisible');
    const masterOpen    = document.getElementById('toggleAllOpen');

    items.forEach(li => {
        const cbVisible = li.querySelector('.panel-enabled-checkbox');
        const cbOpen    = li.querySelector('.panel-open-checkbox');

        if (cbVisible) {
            cbVisible.addEventListener('change', () => {
                if (masterVisible) {
                    const allChecked = Array.from(items).every(row => {
                        const c = row.querySelector('.panel-enabled-checkbox');
                        return c && c.checked;
                    });
                    masterVisible.checked = allChecked;
                }
            });
        }

        if (cbOpen) {
            cbOpen.addEventListener('change', () => {
                if (masterOpen) {
                    const allOpen = Array.from(items).every(row => {
                        const c = row.querySelector('.panel-open-checkbox');
                        return c && c.checked;
                    });
                    masterOpen.checked = allOpen;
                }
            });
        }
    });

    if (masterVisible) {
        masterVisible.addEventListener('change', () => {
            const check = masterVisible.checked;
            items.forEach(li => {
                const cb = li.querySelector('.panel-enabled-checkbox');
                if (cb) {
                    cb.checked = check;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        });
    }

    if (masterOpen) {
        masterOpen.addEventListener('change', () => {
            const check = masterOpen.checked;
            items.forEach(li => {
                const cb = li.querySelector('.panel-open-checkbox');
                if (cb) {
                    cb.checked = check;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        });
    }
}

function readSolConfigFromDOM() {
    if (!panelListEl) return getDefaultSolConfigArray();
    const items = panelListEl.querySelectorAll('.panel-item');
    const config = [];

    items.forEach(li => {
        const id           = li.dataset.id;
        const checkboxVis  = li.querySelector('.panel-enabled-checkbox');
        const checkboxOpen = li.querySelector('.panel-open-checkbox');

        config.push({
            id,
            enabled:  checkboxVis  ? checkboxVis.checked  : true,
            acikDurum: checkboxOpen ? checkboxOpen.checked : false,
            isDefault: false
        });
    });

    let defaultIndex = config.findIndex(c => c.enabled && c.acikDurum);
    if (defaultIndex === -1) {
        defaultIndex = config.findIndex(c => c.enabled);
    }
    if (defaultIndex !== -1) {
        config.forEach((c, idx) => {
            c.isDefault = (idx === defaultIndex);
        });
    }

    return config;
}

function initSolSortable() {
    if (!window.Sortable || !panelListEl) {
        console.error('SortableJS veya panelList bulunamadÄ±.');
        return;
    }
    if (solSortableInstance) {
        solSortableInstance.destroy();
        solSortableInstance = null;
    }

    solSortableInstance = new Sortable(panelListEl, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
    });
}

/* ---------- HIZLI ERÄ°ÅžÄ°M TANIMLARI ---------- */
const QUICK_ACTIONS = [
    { id: 'qa-barkod',    icon: 'ðŸ“·', title: 'Barkod / Karekod Okut' },
    { id: 'qa-recete',    icon: 'ðŸ’Š', title: 'Ä°laÃ§ ReÃ§etesi' },
    { id: 'qa-not',       icon: 'ðŸ“', title: 'Hasta Notu Ekle' },
    { id: 'qa-rapor',     icon: 'ðŸ“„', title: 'Rapor OluÅŸtur' },
    { id: 'qa-lab',       icon: 'ðŸ§ª', title: 'Laboratuvar Ä°stem' },
    { id: 'qa-radyoloji', icon: 'ðŸ©»', title: 'Radyoloji Ä°stem' },
    { id: 'qa-enabiz',    icon: 'ðŸŒ', title: 'e-NabÄ±z Klinik Bilgi' },
    { id: 'qa-risk',      icon: 'âš ï¸', title: 'Risk / UyarÄ±' },
    { id: 'qa-acil',      icon: 'ðŸš¨', title: 'Acil Durum' },
    { id: 'qa-takvim',    icon: 'ðŸ“…', title: 'Takvim / Randevu' }
];

function getDefaultQuickConfigArray() {
    return QUICK_ACTIONS.map(a => ({
        id: a.id,
        enabled: true
    }));
}

function getDefaultQuickAlign() {
    return 'right';
}

function loadQuickRawMultiConfig() {
    try {
        const raw = localStorage.getItem(QUICK_STORAGE_KEY);
        if (!raw) {
            return { desktop: null, tablet: null, mobile: null };
        }
        const parsed = JSON.parse(raw);

        if (Array.isArray(parsed)) {
            return {
                desktop: parsed,
                tablet: parsed,
                mobile: parsed
            };
        }

        if (parsed && typeof parsed === 'object') {
            return {
                desktop: parsed.desktop || null,
                tablet:  parsed.tablet  || null,
                mobile:  parsed.mobile  || null
            };
        }

        return { desktop: null, tablet: null, mobile: null };
    } catch (e) {
        console.error('quickAccessConfig parse hatasÄ±:', e);
        return { desktop: null, tablet: null, mobile: null };
    }
}

function normalizeQuickItems(arr) {
    const knownIds = new Set(QUICK_ACTIONS.map(q => q.id));
    const tmp = [];

    for (const item of arr || []) {
        if (!item || typeof item.id !== 'string') continue;
        if (!knownIds.has(item.id)) continue;
        tmp.push({
            id: item.id,
            enabled: item.enabled !== false
        });
    }

    const existingIds = new Set(tmp.map(r => r.id));
    for (const a of QUICK_ACTIONS) {
        if (!existingIds.has(a.id)) {
            tmp.push({
                id: a.id,
                enabled: true
            });
        }
    }

    // GÃ¶rÃ¼nsÃ¼n seÃ§ili olanlarÄ± Ã¼ste al (stable)
    const enabledArr = [];
    const disabledArr = [];
    for (const it of tmp) {
        if (it.enabled) enabledArr.push(it);
        else disabledArr.push(it);
    }
    return enabledArr.concat(disabledArr);
}

function loadQuickConfigForActiveMode() {
    const rawMulti = loadQuickRawMultiConfig();
    let block = rawMulti[ACTIVE_MODE];

    // Aktif mod boÅŸsa, eski kayÄ±tlardan (desktop/tablet/mobile) birini fallback olarak kullan
    if (!block) {
        if (Array.isArray(rawMulti.desktop) || (rawMulti.desktop && typeof rawMulti.desktop === 'object')) {
            block = rawMulti.desktop;
        } else if (Array.isArray(rawMulti.tablet) || (rawMulti.tablet && typeof rawMulti.tablet === 'object')) {
            block = rawMulti.tablet;
        } else if (Array.isArray(rawMulti.mobile) || (rawMulti.mobile && typeof rawMulti.mobile === 'object')) {
            block = rawMulti.mobile;
        }
    }

    let itemsArr;
    let align = getDefaultQuickAlign();
    let barVisible = true;  // varsayÄ±lan: bar aÃ§Ä±k

    if (Array.isArray(block)) {
        // Eski format: sadece dizi
        itemsArr = normalizeQuickItems(block);
    } else if (block && typeof block === 'object') {
        // Yeni format: { items:[...], align:'...', barVisible:true/false }
        const rawItems = Array.isArray(block.items)
            ? block.items
            : getDefaultQuickConfigArray();

        itemsArr = normalizeQuickItems(rawItems);

        if (block.align) {
            align = block.align;
        }
        if (typeof block.barVisible === 'boolean') {
            barVisible = block.barVisible;
        }
    } else {
        // HiÃ§ config yoksa
        itemsArr = normalizeQuickItems(getDefaultQuickConfigArray());
    }

    return { items: itemsArr, align, barVisible };
}

function saveQuickConfigForActiveMode(itemsArray, alignValue, barVisible) {
    try {
        const rawMulti = loadQuickRawMultiConfig();

        rawMulti[ACTIVE_MODE] = {
            items: itemsArray,
            align: alignValue || getDefaultQuickAlign(),
            barVisible: barVisible
        };

        const toStore = {
            desktop: rawMulti.desktop || null,
            tablet:  rawMulti.tablet  || null,
            mobile:  rawMulti.mobile  || null
        };

        localStorage.setItem(QUICK_STORAGE_KEY, JSON.stringify(toStore));
    } catch (e) {
        console.error('Quick config kaydedilirken hata:', e);
        throw e;
    }
}

function renderQuickList(configParam) {
    if (!quickListEl) return;
    quickListEl.innerHTML = '';

    let itemsConfig;
    let align = getDefaultQuickAlign();

let barVisible = true;  // varsayÄ±lan
if (configParam && typeof configParam.barVisible !== 'undefined') {
    barVisible = configParam.barVisible;
}
setTimeout(() => {
    const chk = document.getElementById('qaBarVisible');
    if (chk) chk.checked = barVisible;
}, 0);


    if (Array.isArray(configParam)) {
        itemsConfig = normalizeQuickItems(configParam);
    } else if (configParam && Array.isArray(configParam.items)) {
        itemsConfig = normalizeQuickItems(configParam.items);
        if (configParam.align) {
            align = configParam.align;
        }
    } else {
        itemsConfig = normalizeQuickItems(getDefaultQuickConfigArray());
    }

    itemsConfig.forEach(item => {
        const def = QUICK_ACTIONS.find(q => q.id === item.id);
        if (!def) return;

        const li = document.createElement('li');
        li.className = 'qa-item';
        li.dataset.id = item.id;

        const visId = 'qa-visible-' + item.id;

        li.innerHTML = `
            <div class="qa-visible">
                <input type="checkbox"
                       id="${visId}"
                       class="qa-enabled-checkbox"
                       ${item.enabled ? 'checked' : ''}>
            </div>
            <div class="qa-main">
                <span class="qa-drag" title="SÃ¼rÃ¼kle">â˜°</span>
                <span class="qa-icon">${def.icon}</span>
                <div>
                    <div class="qa-title">${def.title}</div>
                    <div class="qa-key">${def.id}</div>
                </div>
            </div>
        `;

        quickListEl.appendChild(li);
    });

    const masterVisible = document.getElementById('qaToggleAllVisible');
    const items = quickListEl.querySelectorAll('.qa-item');

    if (masterVisible) {
        const anyOff = itemsConfig.some(c => !c.enabled);
        masterVisible.checked = !anyOff;
    }

    const radios = document.querySelectorAll('input[name="qaAlign"]');
    let found = false;
    radios.forEach(r => {
        if (r.value === align) {
            r.checked = true;
            found = true;
        }
    });
    if (!found && radios.length) {
        radios.forEach(r => { r.checked = (r.value === getDefaultQuickAlign()); });
    }

    items.forEach(li => {
        const cb = li.querySelector('.qa-enabled-checkbox');
        if (cb) {
            cb.addEventListener('change', () => {
                if (masterVisible) {
                    const allOn = Array.from(items).every(row => {
                        const c = row.querySelector('.qa-enabled-checkbox');
                        return c && c.checked;
                    });
                    masterVisible.checked = allOn;
                }
            });
        }
    });

    if (masterVisible) {
        masterVisible.addEventListener('change', () => {
            const check = masterVisible.checked;
            const items2 = quickListEl.querySelectorAll('.qa-item');
            items2.forEach(li => {
                const c = li.querySelector('.qa-enabled-checkbox');
                if (c) {
                    c.checked = check;
                    c.dispatchEvent(new Event('change'));
                }
            });
        });
    }

    initQuickSortable();
}

function readQuickConfigFromDOM() {
    if (!quickListEl) return getDefaultQuickConfigArray();
    const items = quickListEl.querySelectorAll('.qa-item');
    const config = [];

    items.forEach(li => {
        const id          = li.dataset.id;
        const checkboxVis = li.querySelector('.qa-enabled-checkbox');

        config.push({
            id,
            enabled: checkboxVis ? checkboxVis.checked : true
        });
    });

    return config;
}

function initQuickSortable() {
    if (!window.Sortable || !quickListEl) {
        console.error('SortableJS veya quickList bulunamadÄ±.');
        return;
    }
    if (quickSortableInstance) {
        quickSortableInstance.destroy();
        quickSortableInstance = null;
    }

    quickSortableInstance = new Sortable(quickListEl, {
        animation: 150,
        handle: '.qa-drag',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
    });
}

/* ---------- BAÅžLATMA & BUTONLAR ---------- */

const initialSolConfig   = loadSolConfigForActiveMode();
renderSolList(initialSolConfig);

const initialQuickConfig = loadQuickConfigForActiveMode();
renderQuickList(initialQuickConfig);

if (saveAllBtn) {
    saveAllBtn.addEventListener('click', () => {
        try {
            const newSolConfig   = readSolConfigFromDOM();
            const newQuickItems  = readQuickConfigFromDOM();
	    const barVisible = document.getElementById('qaBarVisible').checked;

            let newQuickAlign = getDefaultQuickAlign();
            const radios = document.querySelectorAll('input[name="qaAlign"]');
            radios.forEach(r => {
                if (r.checked) {
                    newQuickAlign = r.value;
                }
            });

            saveSolConfigForActiveMode(newSolConfig);
            saveQuickConfigForActiveMode(newQuickItems, newQuickAlign, barVisible);


            showStatus('TÃ¼m ayarlar kaydedildi.', true);

            setTimeout(() => {
                window.location.href = 'drhastabasi.html';
            }, 300);
        } catch (e) {
            showStatus('Ayarlar kaydedilirken hata oluÅŸtu.', false);
        }
    });
}

if (resetSolBtn) {
    resetSolBtn.addEventListener('click', () => {
        const def = getDefaultSolConfigArray();
        renderSolList(def);
        saveSolConfigForActiveMode(def);
        showStatus('Sol Panel varsayÄ±lanlara dÃ¶ndÃ¼.', true);
    });
}

if (resetQuickBtn) {
    resetQuickBtn.addEventListener('click', () => {
        const defItems = getDefaultQuickConfigArray();
        const defAlign = getDefaultQuickAlign();
        renderQuickList({ items: defItems, align: defAlign, barVisible: true });
        saveQuickConfigForActiveMode(defItems, defAlign, true);
        showStatus('HÄ±zlÄ± EriÅŸim varsayÄ±lanlara dÃ¶ndÃ¼.', true);
    });
}

const closeConfigBtn = document.getElementById('closeConfigBtn');
if (closeConfigBtn) {
    closeConfigBtn.addEventListener('click', () => {
        window.location.href = 'drhastabasi.html';
    });
}

const solPanelSection = document.getElementById('solPanelSection');
const solPanelToggle  = document.getElementById('solPanelToggle');
if (solPanelSection && solPanelToggle) {
    solPanelToggle.addEventListener('click', () => {
        solPanelSection.classList.toggle('collapsed');
    });
}

const quickSection = document.getElementById('quickSection');
const quickToggle  = document.getElementById('quickToggle');
if (quickSection && quickToggle) {
    quickToggle.addEventListener('click', () => {
        quickSection.classList.toggle('collapsed');
    });
}
</script>
</body>
</html>
