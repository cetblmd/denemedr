<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Hasta Bilgisi Özelleştir</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SortableJS: sürükle-bırak için -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f3f4f6;
            color: #111827;
        }
        .page {
            max-width: 720px;
            margin: 20px auto;
            background: #ffffff;
            border-radius: 12px;
            padding: 16px 18px 20px;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
            position: relative;
        }
        h1 {
            font-size: 20px;
            margin: 0 0 4px;
        }
        .subtitle {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 16px;
        }

        /* ÜSTTEKİ KAPAN (X) BUTONU */
        #closeConfigBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            background: #ff5c5c;
            border: none;
            color: white;
            padding: 4px 7px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
        }

        /* FONT AYARLARI BÖLÜMÜ */
        .font-section {
            margin-bottom: 16px;
            padding: 10px 12px;
            border-radius: 10px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        .font-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 16px;
            align-items: center;
            margin-bottom: 8px;
        }
        .font-row label {
            font-size: 13px;
            color: #374151;
            min-width: 150px;
        }
        select, input[type="number"] {
            font-size: 13px;
            padding: 3px 6px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            min-width: 150px;
        }
        .font-info {
            font-size: 11px;
            color: #6b7280;
        }

        .panel-list {
            list-style: none;
            padding: 0;
            margin: 0 0 12px;
        }

        /* ÜST BAŞLIK VE SATIRLAR AYNI GRID YAPISI
           [ Görünsün ] [ Grup adı ] [ Açılışta açık ]
        */
        .panel-header,
        .panel-item {
            display: grid;
            grid-template-columns: 70px minmax(0, 1fr) 130px;
            align-items: center;
            padding: 8px 10px;
        }

        .panel-header {
            margin-bottom: 8px;
            padding-left: 10px;
            padding-right: 10px;
            font-size: 13px;
            color: #374151;
            font-weight: 600;
        }

        .panel-item {
            margin-bottom: 6px;
            border-radius: 8px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            cursor: grab;
            transition: box-shadow 0.15s ease, transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
        }

        .panel-left {
            grid-column: 2;
            display: flex;
            align-items: center;
            gap: 14px;
            margin-left: -24px;
        }

        .drag-handle {
            font-size: 18px;
            user-select: none;
            color: #9ca3af;
            cursor: grab;
        }
        .panel-title {
            font-size: 14px;
            font-weight: 500;
        }
        .panel-key {
            font-size: 11px;
            color: #9ca3af;
        }

        .col-visible {
            grid-column: 1;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 0;
            gap: 4px;
        }

        .col-default {
            grid-column: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .ph-visible-label,
        .ph-default-label {
            font-size: 13px;
        }

        .group-visible-checkbox,
        .group-open-checkbox,
        #toggleAllVisible,
        #toggleAllOpen {
            width: 16px;
            height: 16px;
            margin: 0;
            vertical-align: middle;
        }

        .panel-item.sortable-chosen {
            border-color: #0b3c61;
            background: #eef2ff;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.25);
            transform: scale(1.01);
            z-index: 10;
        }
        .panel-item.sortable-ghost {
            opacity: 0.4;
        }

        .btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }
        .btn {
            border-radius: 999px;
            border: 1px solid transparent;
            font-size: 13px;
            padding: 6px 14px;
            cursor: pointer;
        }
        .btn-ghost {
            background: #ffffff;
            border-color: #d1d5db;
            color: #374151;
        }
        .btn-ghost:hover {
            background: #f3f4f6;
        }
        .btn-primary {
            background: #0b3c61;
            color: #ffffff;
        }
        .btn-primary:hover {
            background: #0d4979;
        }

        .info {
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
        }
        .badge-ok {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: #ecfdf3;
            color: #15803d;
            margin-left: 6px;
        }
        .badge-error {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: #fef2f2;
            color: #b91c1c;
            margin-left: 6px;
        }
        #statusBadge {
            display: inline-block;
            margin-left: 4px;
        }

        @media (max-width: 600px) {
            .page {
                margin: 8px;
                padding: 12px;
            }

            .panel-header,
            .panel-item {
                grid-template-columns: 60px minmax(0, 1.6fr) 110px;
            }

            .ph-visible-label,
            .ph-default-label {
                font-size: 11px;
                white-space: nowrap;
            }

            .panel-title {
                font-size: 13px;
            }

            .font-row {
                flex-direction: column;
                align-items: flex-start;
            }

            select, input[type="number"] {
                width: 100%;
                max-width: 260px;
            }
        }
    </style>
</head>
<body>

<div class="page">

    <button id="closeConfigBtn">✖</button>

    <h1>Hasta Bilgisi Özelleştir</h1>
    <div class="subtitle">
        Bu ekrandan hasta bilgisi sayfası için font, boyut ve grup sıralama / görünürlük ayarlarını yapabilirsiniz.
        <span id="statusBadge"></span>
    </div>

    <!-- FONT AYARLARI -->
    <div class="font-section">
        <div class="font-row">
            <label for="fontFamilySelect">Tıbbi özet yazı tipi:</label>
            <select id="fontFamilySelect">
                <option value='system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'>
                    Varsayılan (Sistem)
                </option>
                <option value='"Aptos", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'>
                    Aptos (yüklüyse)
                </option>
                <option value='Arial, "Helvetica Neue", Helvetica, sans-serif'>
                    Arial / Helvetica
                </option>
                <option value='"Times New Roman", Times, serif'>
                    Times New Roman
                </option>
            </select>
        </div>
        <div class="font-row">
            <label for="fontSizeInput">Tıbbi özet başlangıç boyutu (px):</label>
            <input id="fontSizeInput"
                   type="number"
                   min="11"
                   max="24"
                   step="0.5" />
        </div>
        <div class="font-info">
            Hasta Bilgisi ekranındaki <strong>+</strong> / <strong>−</strong> butonları, burada belirlediğiniz boyutun etrafında çalışır.
        </div>
    </div>

    <!-- GRUP SIRALAMA / GÖRÜNÜRLÜK -->
    <div class="panel-header">
        <div class="col-visible">
            <input type="checkbox" id="toggleAllVisible">
            <span class="ph-visible-label">Görünsün</span>
        </div>
        <div></div>
        <div class="col-default">
            <input type="checkbox" id="toggleAllOpen">
            <span class="ph-default-label">Açılışta açık</span>
        </div>
    </div>

    <ul id="groupList" class="panel-list">
        <!-- JS ile doldurulacak -->
    </ul>

    <div class="info">
        • Satırın solundaki ☰ simgesinden tutup sürükleyerek grupların sırasını değiştirebilirsiniz. <br>
        • İşaretli olan gruplar hasta bilgisi ekranında görünecek. <br>
        • “Açılışta açık” işaretli gruplar, sayfa ilk açıldığında açık olacak. <br>
        • Değişiklikler tarayıcıya kayıt edilir (localStorage).
    </div>

    <div class="btn-row">
        <button id="resetBtn" class="btn btn-ghost">Varsayılanları Yükle</button>
        <button id="saveBtn" class="btn btn-primary">Kaydet</button>
    </div>
</div>

<script>
/**
 * Hasta bilgisi ekranındaki gruplar:
 * id: hastabilgisi.html içindeki section kimliği
 */
const ALL_GROUPS = [
    { id: 'kimlik',   title: 'Kimlik ve Protokol Bilgileri' },
    { id: 'tibbi',    title: 'Hasta Tıbbi Özeti' },
    { id: 'iletisim', title: 'İletişim Bilgileri' }
];

const STORAGE_KEY = 'hbHastaBilgisiAyarlar';

const groupListEl   = document.getElementById('groupList');
const saveBtn       = document.getElementById('saveBtn');
const resetBtn      = document.getElementById('resetBtn');
const statusBadge   = document.getElementById('statusBadge');
const closeConfigBtn= document.getElementById('closeConfigBtn');
const fontFamilySel = document.getElementById('fontFamilySelect');
const fontSizeInput = document.getElementById('fontSizeInput');

let sortableInstance = null;

/** Varsayılan ayar seti */
function getDefaultConfig() {
    return {
        fontFamily: 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
        fontSize: 13.5,
        groups: [
            { id: 'kimlik',   title: 'Kimlik ve Protokol Bilgileri', visible: true,  isOpen: false },
            { id: 'tibbi',    title: 'Hasta Tıbbi Özeti',            visible: true,  isOpen: true  },
            { id: 'iletisim', title: 'İletişim Bilgileri',           visible: true,  isOpen: true  }
        ]
    };
}

/** localStorage’tan ayarları yükle */
function loadConfig() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return getDefaultConfig();
        const parsed = JSON.parse(raw);
        const base   = getDefaultConfig();

        const cfg = {
            fontFamily: parsed.fontFamily || base.fontFamily,
            fontSize:   parsed.fontSize   || base.fontSize,
            groups: []
        };

        // Grup listesini merge et
        const knownIds = new Set(ALL_GROUPS.map(g => g.id));

        // Önce gelen config'in sırasını koru
        if (Array.isArray(parsed.groups)) {
            parsed.groups.forEach(g => {
                if (!g || typeof g.id !== 'string') return;
                if (!knownIds.has(g.id)) return;
                const defMeta = ALL_GROUPS.find(a => a.id === g.id);

                const isOpen = !!(
                    g.isOpen ||
                    g.acikDurum ||
                    g.open ||
                    g.isDefault
                );

                cfg.groups.push({
                    id: g.id,
                    title: defMeta ? defMeta.title : (g.title || g.id),
                    visible: g.visible !== false,
                    isOpen: isOpen
                });
            });
        }

        // Eksik grupları sona ekle
        const existingIds = new Set(cfg.groups.map(g => g.id));
        ALL_GROUPS.forEach(def => {
            if (!existingIds.has(def.id)) {
                const defMeta = base.groups.find(bg => bg.id === def.id);
                cfg.groups.push({
                    id: def.id,
                    title: def.title,
                    visible: defMeta ? defMeta.visible : true,
                    isOpen: defMeta ? defMeta.isOpen : false
                });
            }
        });

        return cfg;
    } catch (e) {
        console.error('Ayarlar okunurken hata:', e);
        return getDefaultConfig();
    }
}

/** ayarları localStorage’a kaydet */
function saveConfig(config) {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
        showStatus('Ayarlar kaydedildi.', true);
    } catch (e) {
        console.error('Ayarlar kaydedilirken hata:', e);
        showStatus('Ayarlar kaydedilemedi!', false);
    }
}

/** Küçük status rozeti */
function showStatus(text, ok) {
    if (!statusBadge) return;
    statusBadge.innerHTML = '';
    const span = document.createElement('span');
    span.textContent = text;
    span.className = ok ? 'badge-ok' : 'badge-error';
    statusBadge.appendChild(span);
    setTimeout(() => {
        if (statusBadge.contains(span)) {
            statusBadge.removeChild(span);
        }
    }, 2500);
}

/** Listeyi ekrana bas */
function renderGroupList(cfg) {
    groupListEl.innerHTML = '';

    cfg.groups.forEach(group => {
        const li = document.createElement('li');
        li.className = 'panel-item';
        li.dataset.id = group.id;

        const visId = 'visible-' + group.id;
        const openId = 'open-' + group.id;

        li.innerHTML = `
            <div class="col-visible">
                <input type="checkbox"
                       id="${visId}"
                       class="group-visible-checkbox"
                       ${group.visible ? 'checked' : ''}>
            </div>

            <div class="panel-left">
                <span class="drag-handle" title="Sürükle">☰</span>
                <div>
                    <div class="panel-title">${group.title}</div>
                    <div class="panel-key">${group.id}</div>
                </div>
            </div>

            <div class="col-default">
                <input type="checkbox"
                       id="${openId}"
                       class="group-open-checkbox"
                       ${group.visible ? '' : 'disabled'}
                       ${group.visible && group.isOpen ? 'checked' : ''}>
            </div>
        `;

        groupListEl.appendChild(li);
    });

    // Master "Görünsün" checkbox'ı
    const masterVisible = document.getElementById('toggleAllVisible');
    if (masterVisible) {
        const anyHidden = cfg.groups.some(g => !g.visible);
        masterVisible.checked = !anyHidden;
    }

    // Master "Açılışta açık" checkbox'ı
    const masterOpen = document.getElementById('toggleAllOpen');
    if (masterOpen) {
        const anyOpen = cfg.groups.some(g => g.visible !== false && g.isOpen);
        const allVisibleOpen = cfg.groups
            .filter(g => g.visible !== false)
            .every(g => g.isOpen);
        masterOpen.checked = allVisibleOpen && anyOpen;
    }

    initSortable();
    attachGroupInteractions();
}

/** Sürükle-bırak ayarla */
function initSortable() {
    if (!window.Sortable) {
        console.error('SortableJS yüklenemedi.');
        return;
    }
    if (sortableInstance) {
        sortableInstance.destroy();
        sortableInstance = null;
    }
    sortableInstance = new Sortable(groupListEl, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag'
    });
}

/** Satırlardaki checkbox davranışlarını bağla */
function attachGroupInteractions() {
    const items = groupListEl.querySelectorAll('.panel-item');
    const masterVisible = document.getElementById('toggleAllVisible');
    const masterOpen    = document.getElementById('toggleAllOpen');

    items.forEach(li => {
        const cb     = li.querySelector('.group-visible-checkbox');
        const openCb = li.querySelector('.group-open-checkbox');
        if (!cb) return;

        // Görünsün değişince
        cb.addEventListener('change', () => {
            if (!cb.checked) {
                if (openCb) {
                    openCb.checked = false;
                    openCb.disabled = true;
                }
            } else {
                if (openCb) {
                    openCb.disabled = false;
                }
            }

            // Master "Görünsün" güncelle
            if (masterVisible) {
                const allVisible = Array.from(items).every(li2 => {
                    const c = li2.querySelector('.group-visible-checkbox');
                    return c && c.checked;
                });
                masterVisible.checked = allVisible;
            }

            // Master "Açılışta açık" güncelle (sadece görünen grupları dikkate al)
            if (masterOpen) {
                const visibleItems = Array.from(items).filter(li2 => {
                    const c = li2.querySelector('.group-visible-checkbox');
                    return c && c.checked;
                });
                if (visibleItems.length === 0) {
                    masterOpen.checked = false;
                } else {
                    const allOpen = visibleItems.every(li2 => {
                        const oc = li2.querySelector('.group-open-checkbox');
                        return oc && oc.checked;
                    });
                    masterOpen.checked = allOpen;
                }
            }
        });

        // Satır bazlı "Açılışta açık" değişince masterOpen'ı güncelle
        if (openCb) {
            openCb.addEventListener('change', () => {
                if (!masterOpen) return;
                const visibleItems = Array.from(items).filter(li2 => {
                    const c = li2.querySelector('.group-visible-checkbox');
                    return c && c.checked;
                });
                if (visibleItems.length === 0) {
                    masterOpen.checked = false;
                } else {
                    const allOpen = visibleItems.every(li2 => {
                        const oc = li2.querySelector('.group-open-checkbox');
                        return oc && oc.checked;
                    });
                    masterOpen.checked = allOpen;
                }
            });
        }
    });

    // Master "Görünsün" → tüm satırların Görünsün'ünü değiştir
    if (masterVisible) {
        masterVisible.addEventListener('change', () => {
            const check = masterVisible.checked;
            items.forEach(li => {
                const cb     = li.querySelector('.group-visible-checkbox');
                const openCb = li.querySelector('.group-open-checkbox');
                if (cb) {
                    cb.checked = check;
                    if (openCb) {
                        openCb.disabled = !check;
                        if (!check) {
                            openCb.checked = false;
                        }
                    }
                    cb.dispatchEvent(new Event('change'));
                }
            });
        });
    }

    // Master "Açılışta açık" → tüm satırların open checkbox'ını değiştir
    if (masterOpen) {
        masterOpen.addEventListener('change', () => {
            const check = masterOpen.checked;
            items.forEach(li => {
                const cb     = li.querySelector('.group-visible-checkbox');
                const openCb = li.querySelector('.group-open-checkbox');
                if (!openCb) return;

                // Görünmeyen satırlar için open anlamsız, pas geç
                if (cb && !cb.checked) {
                    openCb.checked  = false;
                    openCb.disabled = true;
                    return;
                }

                openCb.disabled = false;
                openCb.checked  = check;
            });
        });
    }
}

/** DOM’dan mevcut konfigürasyonu oku */
function readConfigFromDOM(baseConfig) {
    const items = groupListEl.querySelectorAll('.panel-item');
    const groups = [];
    items.forEach(li => {
        const id  = li.dataset.id;
        const cb  = li.querySelector('.group-visible-checkbox');
        const openCb = li.querySelector('.group-open-checkbox');
        const defMeta = ALL_GROUPS.find(g => g.id === id);
        groups.push({
            id,
            title: defMeta ? defMeta.title : id,
            visible: cb ? cb.checked : true,
            isOpen: openCb ? (openCb.checked && (cb ? cb.checked : true)) : false
        });
    });

    const fontFamily = fontFamilySel.value || baseConfig.fontFamily;
    let fontSize = parseFloat(fontSizeInput.value);
    if (isNaN(fontSize)) fontSize = baseConfig.fontSize;
    if (fontSize < 11) fontSize = 11;
    if (fontSize > 24) fontSize = 24;

    return {
        fontFamily,
        fontSize,
        groups
    };
}

/** Başlatma */
const initialConfig = loadConfig();

// Font alanlarını doldur
fontFamilySel.value = initialConfig.fontFamily;
fontSizeInput.value = initialConfig.fontSize;

// Grup listesini çiz
renderGroupList(initialConfig);

// Kaydet butonu
if (saveBtn) {
    saveBtn.addEventListener('click', () => {
        const newConfig = readConfigFromDOM(initialConfig);
        saveConfig(newConfig);

        // İstersen hemen hastaBilgisi sayfasına dönebiliriz:
        setTimeout(() => {
            window.location.href = 'hastabilgisi.html';
        }, 300);
    });
}

// Varsayılanlara dön
if (resetBtn) {
    resetBtn.addEventListener('click', () => {
        const def = getDefaultConfig();
        fontFamilySel.value = def.fontFamily;
        fontSizeInput.value = def.fontSize;
        renderGroupList(def);
        saveConfig(def);
    });
}

// X (çık) butonu
if (closeConfigBtn) {
    closeConfigBtn.addEventListener('click', () => {
        window.location.href = 'hastabilgisi.html';
    });
}
</script>
</body>
</html>
